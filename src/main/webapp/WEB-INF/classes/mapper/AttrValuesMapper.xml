<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
    <!--
		<mapper namespace="com.smm.cuohe.dao.IItemAttrDao" >
		  <resultMap id="BaseResultMap" type="com.smm.cuohe.domain.AttrValues" >
		      WARNING - @mbggenerated
		      This element is automatically generated by MyBatis Generator, do not modify.
		    <id column="id" property="id" jdbcType="INTEGER" />
		    <result column="AttrID" property="attrid" jdbcType="INTEGER" />
		    <result column="AttrName" property="attrname" jdbcType="VARCHAR" />
		    <result column="AttrValue" property="attrvalue" jdbcType="VARCHAR" />
		    <result column="ExtID" property="extid" jdbcType="VARCHAR" />
		    <result column="Status" property="status" jdbcType="INTEGER" />
		    <result column="CreatedAt" property="createdat" jdbcType="DATE" />
		    <result column="CreatedBy" property="createdby" jdbcType="INTEGER" />
		    <result column="UpdatedAt" property="updatedat" jdbcType="DATE" />
		    <result column="UpdatedBy" property="updatedby" jdbcType="INTEGER" />
		  </resultMap>
		</mapper>
    -->
<mapper namespace="com.smm.cuohe.dao.IAttrValuesDao">
	<select id="getAttrValuesByExtId" parameterType="java.lang.Integer" resultType="com.smm.cuohe.domain.AttrValue">
	SELECT  id,commodity_id  AS commodityId  ,attr_Name as attrName ,attr_Value as attrValue  FROM ch_commodity_attr    WHERE  commodity_id=#{id}
	</select>
	
	<select id="getSellPoolByExtid" parameterType="java.util.Map" resultType="com.smm.cuohe.domain.AttrValue">
		select a.* from ch_attr_values a
		
		where a.commodity_id = #{extid}
		
	</select>
	
	<update id="updateAttrvalue" parameterType="java.util.Map">
		UPDATE ch_attr_values a SET
		a.Status='1' WHERE a.commodity_id = #{extid}
	
	</update>
	<!-- 查询品目下的 商品 -->
	<select id="getproductitemId" parameterType="java.lang.Integer" resultType="com.smm.cuohe.domain.dealmake.ProductEntity">
	
		SELECT * FROM  ch_product WHERE cat_id=#{value} ORDER BY name ASC
		
	</select>
	
	<!-- 查询产品下的所有商品 -->
	
	<select id="getcommodityproductId"  parameterType="java.lang.Integer" resultType="com.smm.cuohe.domain.dealmake.CommodityEntity">
			SELECT * FROM ch_commodity WHERE prod_id=#{value}
	
	
	</select>
	
	<!-- 查询商品属性 -->
	<select id="getcommodityattr"  parameterType="java.lang.Integer" resultType="com.smm.cuohe.domain.AttrValue">
	SELECT  id,commodity_id commodityId , attr_name attrName , attr_value attrValue  FROM  ch_commodity_attr
	WHERE  commodity_id=#{value}
	
	</select>
	<!-- 验证商品是否存在 -->
	<select id="checkcommodity" parameterType="com.smm.cuohe.domain.AttrValue" resultType="java.lang.Integer">
	SELECT a.commodity_Id as commodityId  FROM ch_commodity_attr  a ,ch_commodity c  WHERE a.commodity_Id=c.id and   
	
	 attr_name=#{attrName}  AND  attr_value= #{attrValue} AND prod_id=#{prodId}  LIMIT 1
	
	
	</select>
	
	<!-- 验证商品是否存在 -->
	<select id="checkcommodity2" resultType="java.lang.Integer">
	
		<![CDATA[
			SELECT a.commodity_id FROM (
				SELECT commodity_id, 
				( CASE
		]]>
		
		<foreach collection="attrvalueList" item="item">
	       WHEN (c.attr_name = #{item.attrName} AND c.attr_value= #{item.attrValue} AND d.prod_id = #{item.prodId} ) THEN 1 
		</foreach>
		
		<![CDATA[  
				ELSE 0 END) AS attrCount
				FROM ch_commodity_attr c,ch_commodity d WHERE c.commodity_id = d.id
		) a GROUP BY a.commodity_id HAVING SUM(a.attrCount) = #{size} LIMIT 1
		]]>
		
	</select>
	
	<!-- 添加商品 -->
	<insert id="addCommodity"  parameterType="com.smm.cuohe.domain.dealmake.CommodityEntity"   useGeneratedKeys="true" keyProperty="id">
	
			INSERT INTO ch_commodity 
			(id,
			NAME, 
			prod_id, 
			cat_id, 
			cat_name, 
			create_time
			)
			VALUES
			( 
			#{id},
			#{name}, 
			#{prodId}, 
			#{catId}, 
			#{catName}, 
			#{createTime}
			);
		 	
	</insert>
	
	
	<!-- 添加商品属性 -->
	<insert id="addCommodityAttr" parameterType="com.smm.cuohe.domain.AttrValue">
	INSERT INTO ch_commodity_attr 
	(
	commodity_id, 
	attr_id, 
	attr_name, 
	attr_value, 
	commodity_name, 
	create_time, 
	edit_time
	)
	VALUES
	( 
	#{commodityId}, 
	#{attrId}, 
	#{attrName}, 
	#{attrValue}, 
	#{commodityName}, 
	#{creaTime}, 
	#{editTime}
	);	
	
	
	</insert>

	<select id="getProductIdByComId" parameterType="java.lang.Integer" resultType="java.lang.Integer">
		SELECT prod_id FROM ch_commodity WHERE id = #{id}
	</select>
	
	<select id="queryAttrId"   parameterType="com.smm.cuohe.domain.AttrValue" resultType="java.lang.Integer">
	SELECT  id FROM  ch_item_attr WHERE  NAME=#{attrName} and  itemId=#{itemId}  LIMIT 1
	
	
	</select>
	
	<select id="queryproNameProId" parameterType="java.lang.Integer" resultType="java.lang.String">
	
	SELECT NAME AS prodName FROM ch_product WHERE id=#{value}
	</select>
</mapper>    