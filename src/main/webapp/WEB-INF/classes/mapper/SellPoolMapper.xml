<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.smm.cuohe.dao.dealmake.ISellPoolDao">
	<resultMap id="BaseResultMap" type="com.smm.cuohe.domain.dealmake.SellPool">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="id" property="id" jdbcType="INTEGER" />
		<!-- 新增“编号”字段，用于商城排序 -->
		<result column="sortNum" property="sortNum" jdbcType="INTEGER" />
		<!-- 商城排序字段：更新时间+编号timeSort -->
		<result column="timeSort" property="timeSort" jdbcType="VARCHAR" />
		
		<result column="ItemsID" property="itemsid" jdbcType="INTEGER" />
		<result column="customerId" property="companyid" jdbcType="INTEGER" />

		<result column="commodity_id" property="commodityId" jdbcType="INTEGER" />

		<result column="quantity" property="quantity" jdbcType="VARCHAR" />
		<result column="unit" property="unit" jdbcType="INTEGER" />
		<result column="ware_province" property="wareProvince" jdbcType="INTEGER" />
		<result column="ware_id" property="wareId" jdbcType="INTEGER" />
		<result column="ware_name" property="wareName" jdbcType="VARCHAR" />
		<result column="price" property="price" jdbcType="DOUBLE" />
		<result column="priceType" property="priceType" jdbcType="INTEGER"/>
		<result column="priority" property="priority" jdbcType="INTEGER" />
		<result column="commands" property="commands" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="orderNum" property="orderNum" jdbcType="INTEGER" />
		<result column="createdAt" property="createdat" jdbcType="TIMESTAMP" />
		<result column="createdBy" property="createdby" jdbcType="INTEGER" />
		<result column="updatedAt" property="updatedat" jdbcType="TIMESTAMP" />
		<result column="updatedBy" property="updatedby" jdbcType="INTEGER" />
		<result column="commodity_Id" property="commodityId" jdbcType="INTEGER" />
		<result column="mall_Sale_Id" property="mallSaleId" jdbcType="INTEGER" />
		<result column="mall_user_account" property="mallUserAccount" jdbcType="VARCHAR" />
		<result column="code" property="code" jdbcType="VARCHAR" />
		<result column="volume" property="volume" jdbcType="INTEGER" />
		
		<result column="lastCustomerName" property="buyCompanyNm" jdbcType="VARCHAR"/>
		<result column="lastCustomerId" property="buyCompanyId" jdbcType="INTEGER"/>
		<result column="isClose" property="isClose" jdbcType="INTEGER"/>
		<result column="isConfirm" property="isConfirm" jdbcType="INTEGER"/>
		<result column="createSource" property="createSource" jdbcType="INTEGER"/>
		
		<!-- 挂盘公司ID -->
		<result column="customerId" property="customerId" jdbcType="INTEGER"/>
	</resultMap>
	<!-- 新增 -->
	<insert id="addSellPool" parameterType="com.smm.cuohe.domain.dealmake.SellPool"   useGeneratedKeys="true" keyProperty="id">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into ch_sell_pool (ItemsID, customerId,
		quantity, unit,
		ware_province,ware_id,
		ware_name, price, priority,
		commands, status,
		createdAt, createdBy, updatedAt,
		updatedBy, code, volume,commodity_Id,mall_Sale_Id,
		mall_user_account,
		paytype, 
		receipttype, 
		delivery, 
		deliverytime, 
		moq, 
		outmoq, 
		overflow,
		source,
		priceType,
		timeSort,
		initPrice,
		FuturesMonth,
		initPriceType
		<if test="createSource!=null">
		,createSource
		</if>
		)
		values (
		#{itemsid,jdbcType=VARCHAR}, #{companyid,jdbcType=INTEGER},
		#{quantity}, #{unit,jdbcType=INTEGER},
		#{wareProvince,jdbcType=INTEGER},#{wareId,jdbcType=INTEGER},
		getWareHouseNameById(#{wareId,jdbcType=INTEGER}),
		#{price}, #{priority,jdbcType=INTEGER},
		#{commands,jdbcType=VARCHAR}, 
		#{status,jdbcType=INTEGER},
		#{createdat,jdbcType=TIMESTAMP},
		#{createdby,jdbcType=INTEGER}, 
		#{updatedat,jdbcType=TIMESTAMP},
		#{updatedby,jdbcType=INTEGER}, #{code,jdbcType=VARCHAR},
		#{volume,jdbcType=INTEGER},#{commodityId,jdbcType=INTEGER},
		#{mallSaleId,jdbcType=INTEGER},#{mallUserAccount,jdbcType=VARCHAR},
		#{paytype,jdbcType=INTEGER}, 
		#{receipttype,jdbcType=INTEGER}, 
		#{delivery,jdbcType=INTEGER}, 
		#{deliverytime,jdbcType=VARCHAR }, 
		#{moq ,jdbcType=VARCHAR}, 
		#{outmoq ,jdbcType=VARCHAR}, 
		#{overflow ,jdbcType=VARCHAR},
		#{source},
		#{priceType},
	
		#{timeSort},
		
		#{price},
		#{futuresMonth},
		#{priceType}
		<if test="createSource!=null">
		,#{createSource}
		</if>
		)
	</insert>
	
	<!--查询所有卖盘池 -->
	<select id="queryAllSellPool" resultMap="BaseResultMap">
		select * from
		ch_sell_pool
	</select>
	
	

	<select id="getSellPoolByPoolId" parameterType="java.lang.Integer" resultMap="BaseResultMap">
		select * from  ch_sell_pool  where id = #{poolId}
	</select>
	
	
	 <update id="updateSellPoolPrice" parameterType="com.smm.cuohe.domain.dealmake.SellPool" >
	    update ch_sell_pool set lastPriceType = #{lastPriceType},
	        lastPrice = #{lastPrice},
	        lastCustomerId = #{lastCustomerId},
	         lastMallAccount= #{lastMallAccount},
	        lastCustomerName = #{lastCustomerName},
	        poolPriceCount = #{poolPriceCount},
	        lastTime = #{lastTime},
	        isConfirm = #{isConfirm}
	    where id = #{id}
	  </update>

	<!--条件查询 卖盘池的个数 -->
	<select id="querySellPoolCount" parameterType="java.util.Map"
		resultType="Integer">
		select count(*) from ch_sell_pool
	</select>

	<!--分页查询 -->
	<select id="querySellPoolList" parameterType="java.util.Map"
		resultMap="BaseResultMap">
		select * from ch_sell_pool
		<include refid="mysqlPageSearchFoot" />
	</select>


	<sql id="mysqlPageSearchFoot">
		<if test="_orderby != null">
			ORDER BY ${_orderby} ${_order}
		</if>
		<if test="_start != null and _size != null">
			LIMIT #{_start} ,
			#{_size}
		</if>
	</sql>

	<!-- 全部/条件查询，分页 -->
	<select id="querySellOrderList" parameterType="java.util.Map"
		resultMap="BaseResultMap">

		SELECT a.id,a.sortNum, a.commodity_id,b.companyName as companyNm,a.customerId companyID,a.ItemsID,t.name

		as itemsNm,a.quantity,a.price,a.createdAt,
		d.name as
		createdNm,a.priority,a.commands,a.updatedat,e.orderNum as 
		orderNum,g.name as wareNm,mall_Sale_Id,a.priceType

		FROM ch_sell_pool a

		INNER JOIN ch_customs b ON a.customerId = b.id

		INNER JOIN ch_items c ON
		a.ItemsID = c.id

		LEFT JOIN ch_users d ON a.createdBy = d.id
		
		INNER JOIN ch_commodity t on t.id=a.commodity_id
		
		LEFT JOIN ch_commodity_attr ta ON ta.commodity_id = t.id  

		LEFT JOIN (SELECT source_id ,COUNT(id) AS orderNum FROM  ch_orders  WHERE source in (0, 4) GROUP BY source_id) e ON  e.source_id=a.id

		LEFT JOIN ch_warehouse g ON
		
		g.id = a.ware_id

		where a.ItemsID = ${itemsID} and a.source=0 and a.createSource in(0,2) and a.isClose=0 and a.status=0


		<!-- <if test="type!=null and type!='' and type==0"> 全部 </if> -->
		<if test="ids!=null and ids!=''">  <!-- 我创建的 -->
			AND a.id in(${ids})
		</if>
		<if test="type!=null and type!='' and type==1">  <!-- 我创建的 -->
			AND a.createdBy = #{userID}
		</if>
		<if test="type!=null and type!='' and type==2">   <!-- 部门创建的 -->
			AND a.createdBy>0
		</if>
		<!-- 搜索条件 -->
		<if test="parameter1!=null and parameter1!='' and parameter1 == 1">
			AND b.companyName ${parameter2} <!-- 公司 -->
		</if>
		<if test="parameter1!=null and parameter1!='' and  parameter1 == 2">
			AND t.name ${parameter2} <!-- 产品 -->
		</if>
		<if test="parameter1!=null and parameter1!='' and parameter1 == 3"> 
			AND ta.attr_value ${parameter2} 
		</if> 
		<if test="parameter1!=null and parameter1!='' and parameter1 == 4">
			AND a.price ${parameter2} <!-- 价格 -->
		</if>
		<if test="parameter1!=null and parameter1!='' and parameter1 ==5">
			AND a.quantity ${parameter2} <!-- 库存 -->
		</if>
		<if test="parameter1!=null and parameter1!='' and parameter1 ==6">
			AND a.ware_name ${parameter2} <!-- 仓库 -->
		</if>
		<if test="parameter1!=null and parameter1!='' and parameter1 == 7">
			AND a.updatedat ${parameter2} <!-- 更新时间 -->
		</if>
		<!-- <if test="parameter1!=null and parameter1!=''and parameter1 == 8" 
			> AND b.name ${parameter2} 公司 </if> -->
		<if test="parameter1!=null and parameter1!='' and parameter1 == 9">
			AND d.name ${parameter2} <!-- 报价人 -->
		</if>
		GROUP BY a.id
		order  by DATE_FORMAT(a.updatedAt,'%Y-%m-%d') DESC ,a.sortNum DESC,DATE_FORMAT(a.updatedAt,'%H-%i-%S') DESC
		
		<!-- 分页 -->
		<if test="startNum!=null and endNum !=null ">
			limit ${startNum},${endNum}
		</if>
		 
	</select>
	
	

	<update id="delAll" parameterType="int">
		UPDATE ch_sell_pool a SET
		a.status='1' WHERE a.id IN (${value})
	</update>


	<select id="getOfferRecordByCompanyId" parameterType="int"
		resultType="SellPool">

		select code,
		getItemNameById(itemsId) as itemsNm,
		getAttrValueByExtAndName(extid,'品牌') as brand,
		price,
		quantity,
		volume,
		date_format(createdat, '%Y-%m-%d %H:%i:%s') as createdAtStr,
		date_format(updatedat, '%Y-%m-%d %H:%i:%s') as updatedAtStr
		from
		ch_sell_pool
		where companyId= #{companyId}
		order by createdat
		limit
		#{start}, #{len}

	</select>

	<select id="getOfferRecordCountByCompanyId" parameterType="int"
		resultType="int">

		select count(1)
		from ch_sell_pool
		where companyId=
		#{companyId}

	</select>

	<select id="getSellPoolById" parameterType="java.util.Map"  resultMap="BaseResultMap">
		SELECT a.*,a.customerId as companyid,b.name as itemsNm ,c.companyName as companyNm, g.companyName as buyCompanyNms,b.categoryId as gatid,d.name as
		wareNm FROM ch_sell_pool a

		LEFT JOIN ch_items b ON b.id = a.itemsid

		LEFT JOIN ch_customs c ON a.customerId = c.id
		
		LEFT JOIN ch_customs g ON g.id = a.lastCustomerId

		LEFT JOIN ch_warehouse d
		
		ON d.id = a.ware_id

		where a.id = #{sellPoolId}

	</select>

	<!-- 根据企业信息、仓库信息、品目信息获取企业仓库信息 -->
	<select id="getWareInfoByCondition" parameterType="java.lang.String"
		resultType="com.smm.cuohe.domain.dealmake.Warehouse">
		select * from ch_warehouse
		where ${value}
	</select>

	<insert id="insertWareInfo" parameterType="com.smm.cuohe.domain.dealmake.Warehouse">
		<selectKey resultType="java.lang.Integer" order="AFTER"
			keyProperty="id">
			SELECT LAST_INSERT_ID() AS ID
		</selectKey>
		insert into ch_warehouse
		(
		ItemId,
		name,
		company,
		address,
		areaid,
		status,
		createdAt,
		createdBy,
		updateAt,
		updateBy
		)
		values
		(
		#{ItemId},
		#{name},
		#{company},
		#{address},
		#{areaid},
		#{status},
		#{createdAt,jdbcType=TIMESTAMP},
		#{createdBy},
		#{updateAt,jdbcType=TIMESTAMP},
		#{updateBy}
		)
	</insert>

	<update id="updateWareInfo" parameterType="com.smm.cuohe.domain.dealmake.Warehouse">
		update ch_warehouse set
		<if test="ItemId!=null"> ItemId=#{ItemId},</if>
		<if test="name!=null"> name=#{name},</if>
		<if test="company!=null"> company=#{company},</if>
		<if test="address!=null"> address=#{address},</if>
		<if test="areaid!=null"> areaid=#{areaid},</if>
		<if test="status!=null"> status=#{status},</if>
		<if test="updateAt!=null"> updateAt=#{updateAt,jdbcType=TIMESTAMP},</if>
		<if test="updateBy!=null"> updateBy=#{updateBy}</if>
		where id=#{id}
	</update>

	<!-- 根据属性信息获得属性值信息 -->
	<select id="getAttrValByCondition" parameterType="java.lang.String"
		resultType="com.smm.cuohe.domain.AttrValues">

		select * FROM
		ch_attr_values
		where ${value}

	</select>

	<insert id="insertAttrValueInfo" parameterType="com.smm.cuohe.domain.AttrValues">
		insert into
		ch_attr_values
		(
		AttrID,
		AttrName,
		AttrValue,
		ExtID,
		Status,
		CreatedAt,
		CreatedBy,
		UpdatedAt,
		UpdatedBy
		)
		values
		(
		#{attrid},
		#{attrname},
		#{attrvalue},
		#{extid},
		#{status},
		#{createdat,jdbcType=TIMESTAMP},
		#{createdby},
		#{updatedat,jdbcType=TIMESTAMP},
		#{updatedby}
		)
	</insert>

	<update id="updateAttrValueInfo" parameterType="com.smm.cuohe.domain.AttrValues">
		update ch_attr_values set
		<if test="attrid!=null"> AttrID=#{attrid},</if>
		<if test="attrname!=null"> AttrName=#{attrname},</if>
		<if test="attrvalue!=null"> AttrValue=#{attrvalue},</if>
		<if test="extid!=null"> ExtID=#{extid},</if>
		<if test="status!=null"> Status=#{status},</if>
		<if test="updatedat!=null"> UpdatedAt=#{updatedat,jdbcType=TIMESTAMP},</if>
		<if test="updatedby!=null"> UpdatedBy=#{updatedby}</if>
		where id=#{id}
	</update>


	<!-- 根据属性信息获得属性信息 -->
	<select id="getItemAttrByCondition" parameterType="java.lang.String"
		resultType="com.smm.cuohe.domain.ItemAttr">

		select * FROM
		ch_item_attr
		where ${value}

	</select>

	<insert id="insertItemAttrInfo" parameterType="com.smm.cuohe.domain.ItemAttr">
		<selectKey resultType="java.lang.Integer" order="AFTER"
			keyProperty="id">
			SELECT LAST_INSERT_ID() AS ID
		</selectKey>
		insert into
		ch_item_attr (
		itemID, name,
		fillMode, dataRegural,
		`default`,
		options,
		mainProperty, required,
		status, listOrder, createdAt,
		createdBy,
		updatedAt, UpdatedBy
		)
		values ( #{itemid,jdbcType=INTEGER},
		#{name,jdbcType=VARCHAR},
		#{fillmode,jdbcType=INTEGER},
		#{dataregural,jdbcType=INTEGER},
		#{defaulta,jdbcType=VARCHAR},
		#{options,jdbcType=VARCHAR},
		#{mainproperty,jdbcType=INTEGER},
		#{required,jdbcType=INTEGER},
		#{status,jdbcType=INTEGER},
		#{listorder,jdbcType=INTEGER}, #{createdat,jdbcType=TIMESTAMP},
		#{createdby,jdbcType=INTEGER},
		#{updatedat,jdbcType=TIMESTAMP}, #{updatedby,jdbcType=INTEGER}
		)
	</insert>

	<update id="updateItemAttrInfo" parameterType="com.smm.cuohe.domain.ItemAttr">
		update ch_item_attr set
		<if test="itemid!=null"> itemID=#{itemid},</if>
		<if test="name!=null"> name=#{name},</if>
		<if test="fillmode!=null"> fillMode=#{fillmode},</if>
		<if test="dataregural!=null"> dataRegural=#{dataregural},</if>
		<if test="defaulta!=null"> `default`=#{defaulta},</if>
		<if test="options!=null"> options=#{options},</if>
		<if test="mainproperty!=null"> mainProperty=#{mainproperty},</if>
		<if test="required!=null"> required=#{required},</if>
		<if test="status!=null"> status=#{status},</if>
		<if test="listorder!=null"> listOrder=#{listorder},</if>
		updatedAt=#{updatedat,jdbcType=TIMESTAMP},
		UpdatedBy=#{updatedby},
		<if test="price!=null">
		 ,isConfirm=(CASE WHEN lastPrice-#{price} &gt;=0  THEN 1 ELSE isConfirm END)
		</if>
		where
		id=#{id}
	</update>

	<select id="getSellPoolByCondition" parameterType="java.lang.String"
		resultType="com.smm.cuohe.domain.dealmake.SellPoolFull">

		select * 
		from 
		ch_sell_pool
		where ${value} 

	</select>

	<insert id="insertSellPoolInfo" parameterType="com.smm.cuohe.domain.dealmake.SellPoolFull">
		insert into
		ch_sell_pool
		(
		ItemsID,
		companyID,
		quantity,
		unit,
		ware_province,
		ware_id,
		ware_name,
		price,
		priority,
		commands,
		extID,
		status,
		createdAt,
		createdBy,
		updatedAt,
		updatedBy,
		code,
		volume,
		source
		)
		values
		(
		#{ItemsID},
		#{companyID},
		#{quantity},
		#{unit},
		#{ware_province},
		#{ware_id},
		#{ware_name},
		#{price},
		#{priority},
		#{commands},
		#{extID},
		#{status},
		#{createdAt,jdbcType=TIMESTAMP},
		#{createdBy},
		#{updatedAt,jdbcType=TIMESTAMP},
		#{updatedBy},
		#{code},
		#{volume},
		#{source}
		)
	</insert>

	<update id="updateSellPoolInfo" parameterType="com.smm.cuohe.domain.dealmake.SellPoolFull">
		update ch_sell_pool set  id=#{id}
		<if test="ItemsID!=null">,ItemsID=#{ItemsID}</if>
		<if test="companyID!=null"> companyID=#{companyID}</if>
		<if test="quantity!=null">, quantity=#{quantity},</if>
		<if test="unit!=null">, unit=#{unit}</if>
		<if test="ware_province!=null">, ware_province=#{ware_province}</if>
		<if test="ware_id!=null">, ware_id=#{ware_id}</if>
		<if test="ware_name!=null">, ware_name=#{ware_name}</if>
		<if test="price!=null">, price=#{price}</if>
		<if test="priority!=null">, priority=#{priority}</if>
		<if test="commands!=null">, commands=#{commands}</if>		
		<if test="status!=null">, status=#{status}</if>
		<if test="code!=null">, code=#{code}</if>
		<if test="volume!=null">, volume=#{volume}</if>
		<if test="updatedAt!=null">, updatedAt=#{updatedAt}</if>
		<if test="updatedBy!=null">, updatedBy=#{updatedBy}</if>
		<if test="priceType!=null and priceType!=''" >,priceType=#{priceType}</if>
		<if test="price!=null and priceType!=2">
		 ,isConfirm=(CASE WHEN lastPrice-#{price} &gt;=0 and lastPrice>0 THEN 1 ELSE isConfirm END)
		</if>
		<if test="price!=null and priceType==2">
		 ,isConfirm=(CASE WHEN lastPrice-#{price} &lt;=0 lastPrice>0  THEN 1 ELSE isConfirm END)
		</if>
		where id=#{id}
	</update>



	<!-- 根据id获得买盘池信息 -->
	<select id="getListSellPoolById" parameterType="java.lang.String"
		resultMap="BaseResultMap">
		SELECT a.id, a.commodity_id,b.companyName as companyNm,a.customerId companyID,a.ItemsID,t.name

		as itemsNm,a.quantity,a.price,a.createdAt,
		d.name as
		createdNm,a.priority,a.commands,a.updatedat,e.orderNum as 
		orderNum,g.name as wareNm ,a.priceType

		FROM ch_sell_pool a

		INNER JOIN ch_customs b ON a.customerId = b.id

		INNER JOIN ch_items c ON
		a.ItemsID = c.id

		INNER JOIN ch_users d ON a.createdBy = d.id
		INNER JOIN ch_commodity t on t.id=a.commodity_id
		LEFT JOIN
		(SELECT source_id ,COUNT(id) AS orderNum FROM  ch_orders  WHERE source=0 GROUP BY source_id) e ON e.source_id=a.id


		LEFT JOIN ch_warehouse g ON
		g.id = a.ware_id

		where a.id
		in
		<foreach collection="array" item="sellPoolInfo" separator=","
			open="(" close=")">

			#{sellPoolInfo}

		</foreach>
	  order  by  a.updatedAt desc,a.priority ,a.createdAt desc

	</select>
	
	<select id="getListSellForNoRepeat" parameterType="java.util.Map" resultMap="BaseResultMap">
		select a.* from ch_sell_pool a
		
		where a.companyid = #{companyid}
		
		and a.createdby = #{createdby}
		
		and a.status='0'
	</select>
	
	<select id="queryWarehouseById" parameterType="java.util.Map" resultType="com.smm.cuohe.domain.dealmake.Warehouse">
		select * from ch_warehouse  where id = #{wareId}
	</select>
	<!-- 更新卖盘池信息 -->
	<update id="updateSellPool"  parameterType="com.smm.cuohe.domain.dealmake.SellPool" >
		 update ch_sell_pool set id=#{id}
      <if test="itemsid != null" >
        ,ItemsID = #{itemsid,jdbcType=INTEGER}
      </if>
      <if test="companyid != null" >
        ,customerId = #{companyid,jdbcType=INTEGER}
      </if>
      <if test="quantity != null" >
        ,quantity = #{quantity,jdbcType=REAL}
      </if>
      <if test="unit != null" >
        ,unit = #{unit,jdbcType=INTEGER}
      </if>
      <if test="wareProvince != null" >
       , ware_province = #{wareProvince,jdbcType=INTEGER}
      </if>
      <if test="wareId != null" >
        ,ware_id = #{wareId,jdbcType=INTEGER}
      </if>
      <if test="wareName != null" >
        ,ware_name = #{wareName,jdbcType=VARCHAR}
      </if>
      <if test="price != null" >
        ,price = #{price,jdbcType=DECIMAL}
      </if>
      <if test="priority != null" >
       , priority = #{priority,jdbcType=INTEGER}
      </if>
      <if test="commands != null" >
       , commands = #{commands,jdbcType=VARCHAR}
      </if>
      <if test="status != null" >
        ,status = #{status,jdbcType=INTEGER}
      </if>
      <if test="createdat != null" >
       , createdAt = #{createdat,jdbcType=TIMESTAMP}
      </if>
      <if test="createdby != null" >
       ,createdBy = #{createdby,jdbcType=INTEGER}
      </if>
      <if test="updatedat != null" >
        ,updatedAt = #{updatedat,jdbcType=TIMESTAMP}
      </if>
      <if test="updatedby != null" >
       , updatedBy = #{updatedby,jdbcType=INTEGER}
      </if>
      <if test="code != null" >
        ,code = #{code,jdbcType=VARCHAR}
      </if>
      <if test="volume != null" >
        ,volume = #{volume,jdbcType=INTEGER}
      </if>
      <if test="commodityId != null" >
        ,commodity_id = #{commodityId,jdbcType=INTEGER}
      </if>
      <if test="mallSaleId != null" >
       , mall_sale_id = #{mallSaleId,jdbcType=INTEGER}
      </if>
      <if test="mallUserAccount != null" >
       , mall_user_account = #{mallUserAccount,jdbcType=VARCHAR}
      </if>
      <if test="paytype != null" >
        ,paytype = #{paytype,jdbcType=INTEGER}
      </if>
      <if test="receipttype != null" >
       , receipttype = #{receipttype,jdbcType=INTEGER}
      </if>
      <if test="delivery != null" >
       , delivery = #{delivery,jdbcType=INTEGER}
      </if>
      <if test="deliverytime != null" >
       , deliverytime = #{deliverytime,jdbcType=VARCHAR}
      </if>
      <if test="moq != null" >
        ,moq = #{moq,jdbcType=VARCHAR}
      </if>
      <if test="outmoq != null" >
        ,outmoq = #{outmoq,jdbcType=VARCHAR}
      </if>
      <if test="overflow != null" >
        ,overflow = #{overflow,jdbcType=VARCHAR}
      </if>
      <if test="source != null" >
        ,source = #{source,jdbcType=INTEGER}
      </if>
      <if test="lastPriceType != null" >
        ,lastPriceType = #{lastPriceType,jdbcType=INTEGER}
      </if>
      <if test="lastPrice != null" >
       , lastPrice = #{lastPrice,jdbcType=DECIMAL}
      </if>
      <if test="lastCustomerId != null" >
       , lastCustomerId = #{lastCustomerId,jdbcType=INTEGER}
      </if>
      <if test="lastMallAccount != null" >
        ,lastMallAccount = #{lastMallAccount,jdbcType=VARCHAR}
      </if>
      <if test="lastCustomerName != null" >
        ,lastCustomerName = #{lastCustomerName,jdbcType=VARCHAR}
      </if>
      <if test="poolPriceCount != null" >
        ,poolPriceCount = #{poolPriceCount,jdbcType=INTEGER}
      </if>
      <if test="lastTime != null" >
        ,lastTime = #{lastTime,jdbcType=VARCHAR}
      </if>
      <if test="isConfirm != null" >
        ,isConfirm = #{isConfirm,jdbcType=INTEGER}
      </if>
      <if test="orderId != null" >
        ,orderId = #{orderId,jdbcType=VARCHAR}
      </if>
      <if test="priceType != null" >
       , priceType = #{priceType,jdbcType=INTEGER}
      </if>
      <if test="isClose != null" >
       , isClose = #{isClose,jdbcType=INTEGER}
      </if>
      <if test="initprice != null" >
       , initPrice = #{initprice,jdbcType=DECIMAL}
      </if>
      <if test="futuresMonth != null" >
       , FuturesMonth = #{futuresMonth,jdbcType=VARCHAR}
      </if>
      <if test="initPriceType != null" >
       , initPriceType = #{initPriceType,jdbcType=INTEGER}
      </if>
      <if test="createSource != null" >
        ,createSource = #{createSource,jdbcType=INTEGER}
      </if>
      
      <if test="sortNum != null" >
        ,sortNum = #{sortNum,jdbcType=INTEGER}
      </if>
      
       <if test="timeSort != null" >
        ,timeSort = #{timeSort,jdbcType=INTEGER}
      </if>
      
	 <if test="price!=null and priceType!=2">
	  ,isConfirm=(CASE WHEN lastPrice-#{price} &gt;=0 and lastPrice>0 THEN 1 ELSE isConfirm END)
	 </if>
	 <if test="price!=null and priceType==2">
	  ,isConfirm=(CASE WHEN lastPrice-#{price} &lt;=0 lastPrice>0  THEN 1 ELSE isConfirm END)
	 </if>
    where id = #{id,jdbcType=INTEGER}
	</update>
	
	<!-- 根据商品编号  价格 数量 查询挂盘id是否存在 -->
	<select id="selMallSaleIdBy" parameterType="com.smm.cuohe.domain.dealmake.SellPool"  resultType="map">
		SELECT id,mall_sale_id as mailsaleId  FROM ch_sell_pool WHERE price=#{price} AND quantity=#{quantity} AND commodity_id = #{commodityId} and customerId=#{companyid}
	</select>
	
	<!-- 根据ID查询企业名称 -->
	<select id="getcompanyName" parameterType="java.lang.Integer" resultType="java.lang.String">
		SELECT  companyName as NAME  FROM ch_customs	  WHERE id=#{value} 
	</select>
	
	
	<!-- 根据ID查询企业会员账号 -->
	<select id="getcompanyAccount" parameterType="java.lang.Integer" resultType="java.lang.String">
		SELECT  ACCOUNT  FROM ch_customs	  WHERE id=#{value} 
	
	
	</select>
	
	<!-- 判断卖盘是否重复记录 根据 卖家 ，商品 数量，库存 -->
	<select id="countSellpool" parameterType="com.smm.cuohe.domain.dealmake.SellPool" resultType="java.lang.Integer">
	SELECT  COUNT(*) FROM    ch_sell_pool  WHERE  customerId=${companyid}  AND quantity=${quantity} AND price=${price} AND commodity_id=${commodityId}
	
	</select>
	
	<!-- 根据传入条件查询产品信息 -->
	<select	id="getProductByCondition"  parameterType="java.lang.String" resultType="com.smm.cuohe.domain.Product">
		select * from ch_product where 1=1 ${value}
	</select> 
	<update id="fabuSellpool" parameterType="com.smm.cuohe.domain.dealmake.SellPool">
	update  ch_sell_pool set mall_sale_id=#{mallSaleId},updatedAt=#{updatedat},updatedBy=#{updatedby},sortNum=#{sortNum},timeSort=#{timeSort} where id=#{id}
	
	</update>
	
	<select id="getSellPool" parameterType="java.util.HashMap" resultType="java.lang.Integer">
		select  customerId from ch_sell_pool where id = #{poolId}
	</select>
	
	
	<update id="updateSellPoolCreateSource" parameterType="com.smm.cuohe.domain.dealmake.SellPool">
		
		update ch_sell_pool set createSource = 2,mall_sale_id = #{mallSaleId} where id = #{id}
	
	</update>
	
	<select id="getSellByMallId" parameterType="java.lang.Integer" resultType="com.smm.cuohe.domain.dealmake.SellPool">
           	select * from ch_sell_pool where mall_sale_id = ${value}
    </select>
    
    <!-- 卖盘新增“编号” -->
    <update id="updateSellPoolSortNum" parameterType="java.util.Map">
    
    	update  ch_sell_pool set sortNum=#{sortNum},timeSort=#{timeSort} where id=#{sellPoolId}
    	
    </update>
    
    <!-- 根据商城段提供的"挂盘编号"修改报盘 -->
    <update id="updateSellPoolByMallSaleId">
    
    	update  ch_sell_pool set sortNum=#{sortNum},updatedAt=now(),timeSort=#{timeSort} where mall_sale_id = #{mallSaleId}
    
    </update>
    
    <update id="updateSellPool_moca" parameterType="com.smm.cuohe.domain.dealmake.SellPool">
	     update ch_sell_pool set id=#{id}
      <if test="quantity != null" >
        ,quantity = #{quantity,jdbcType=REAL}
      </if>
      
      <if test="price != null" >
        ,price = #{price,jdbcType=DECIMAL}
      </if>
      
      <if test="updatedat != null" >
        ,updatedAt = #{updatedat,jdbcType=TIMESTAMP}
      </if>
      <if test="updatedby != null" >
       , updatedBy = #{updatedby,jdbcType=INTEGER}
      </if>
      
	 <if test="price!=null and priceType!=2">
	  ,isConfirm=(CASE WHEN lastPrice-#{price} &gt;=0 and lastPrice>0 THEN 1 ELSE isConfirm END)
	 </if>
	 
	 <if test="price!=null and priceType==2">
	  ,isConfirm=(CASE WHEN lastPrice-#{price} &lt;=0 lastPrice>0  THEN 1 ELSE isConfirm END)
	 </if>
	 
    	where id = #{id,jdbcType=INTEGER}
    </update>
    
    <update id="updateSellIsCloseAndIsConfirm"  parameterType="java.lang.Integer">
    	
    	UPDATE ch_sell_pool SET isClose=1 , isConfirm=1 WHERE id=#{id}
    	
    </update>
</mapper>